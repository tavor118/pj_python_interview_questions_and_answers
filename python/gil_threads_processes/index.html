<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Andrew><link href=https://tavor118.github.io/python-questions-and-answers/python/gil_threads_processes/ rel=canonical><link href=../async/ rel=prev><link href=../interpreter/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.21"><title>GIL Threads Processes - Python Questions and Answers</title><link rel=stylesheet href=../../assets/stylesheets/main.2a3383ac.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../css/timeago.css><link rel=stylesheet href=../../stylesheets/extra.css><link rel=stylesheet href=../../stylesheets/links.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#gil class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Python Questions and Answers" class="md-header__button md-logo" aria-label="Python Questions and Answers" data-md-component=logo> <img src=../../img/logo.bmp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Python Questions and Answers </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> GIL Threads Processes </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=light-blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/tavor118/pj_python_interview_questions_and_answers title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> tavor118/pj_python_interview_questions_and_answers </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Python Questions and Answers" class="md-nav__button md-logo" aria-label="Python Questions and Answers" data-md-component=logo> <img src=../../img/logo.bmp alt=logo> </a> Python Questions and Answers </label> <div class=md-nav__source> <a href=https://github.com/tavor118/pj_python_interview_questions_and_answers title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> tavor118/pj_python_interview_questions_and_answers </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> Python </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../general/ class=md-nav__link> <span class=md-ellipsis> General </span> </a> </li> <li class=md-nav__item> <a href=../syntax/ class=md-nav__link> <span class=md-ellipsis> Syntax </span> </a> </li> <li class=md-nav__item> <a href=../data_types/ class=md-nav__link> <span class=md-ellipsis> Data Types </span> </a> </li> <li class=md-nav__item> <a href=../sequences/ class=md-nav__link> <span class=md-ellipsis> Sequences </span> </a> </li> <li class=md-nav__item> <a href=../set_and_dict/ class=md-nav__link> <span class=md-ellipsis> Set and Dict </span> </a> </li> <li class=md-nav__item> <a href=../loops/ class=md-nav__link> <span class=md-ellipsis> Loops </span> </a> </li> <li class=md-nav__item> <a href=../functions/ class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> </li> <li class=md-nav__item> <a href=../decorators/ class=md-nav__link> <span class=md-ellipsis> Decorators </span> </a> </li> <li class=md-nav__item> <a href=../iterator_and_generator/ class=md-nav__link> <span class=md-ellipsis> Iterator and Generator </span> </a> </li> <li class=md-nav__item> <a href=../class_and_object/ class=md-nav__link> <span class=md-ellipsis> Class and Object </span> </a> </li> <li class=md-nav__item> <a href=../metaclass/ class=md-nav__link> <span class=md-ellipsis> Metaclass </span> </a> </li> <li class=md-nav__item> <a href=../namespace_and_context_manager/ class=md-nav__link> <span class=md-ellipsis> Namespace and Context Manager </span> </a> </li> <li class=md-nav__item> <a href=../modules_and_packets/ class=md-nav__link> <span class=md-ellipsis> Modules and Packets </span> </a> </li> <li class=md-nav__item> <a href=../exceptions/ class=md-nav__link> <span class=md-ellipsis> Exceptions </span> </a> </li> <li class=md-nav__item> <a href=../files_and_io/ class=md-nav__link> <span class=md-ellipsis> Files and IO </span> </a> </li> <li class=md-nav__item> <a href=../async/ class=md-nav__link> <span class=md-ellipsis> Async </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> GIL Threads Processes </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> GIL Threads Processes </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#gil class=md-nav__link> <span class=md-ellipsis> GIL, потоки, процеси </span> </a> <nav class=md-nav aria-label="GIL, потоки, процеси"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#thread-process class=md-nav__link> <span class=md-ellipsis> Що таке потік (Thread)? Що таке процес (Process)? </span> </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> В чому відмінність потоків від процесів </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> Недоліки потоків </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> Які існують способи синхронізації процесів та потоків ? Як передавати інформацію з одного процесу до іншого? </span> </a> </li> <li class=md-nav__item> <a href=#race-condition class=md-nav__link> <span class=md-ellipsis> Що таке гонка (race condition)? Як з нею боротися? </span> </a> </li> <li class=md-nav__item> <a href=#gil_1 class=md-nav__link> <span class=md-ellipsis> Що таке GIL? Які проблеми в нього є? </span> </a> </li> <li class=md-nav__item> <a href=#gil-i-gc class=md-nav__link> <span class=md-ellipsis> GIL i GC </span> </a> </li> <li class=md-nav__item> <a href=#python class=md-nav__link> <span class=md-ellipsis> Як реалізовано багатопотоковість у Python </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> Життєвий цикл треда </span> </a> </li> <li class=md-nav__item> <a href=#threadpool-threadpool class=md-nav__link> <span class=md-ellipsis> Для чого використовують ThreadPool? Як виділяються та повертаються потоки в ThreadPool? </span> </a> </li> <li class=md-nav__item> <a href=#thread-local class=md-nav__link> <span class=md-ellipsis> Як працює thread local? </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> Які завдання добре паралеляться, а які погано </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> Що таке блокуючі операції </span> </a> </li> <li class=md-nav__item> <a href=#100 class=md-nav__link> <span class=md-ellipsis> Потрібно обчислити 100 рівнянь. Робити це у потоках або ні </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> Що таке грінлети. Загальне поняття. Приклади реалізацій </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> Сигнали та планувальники потоків </span> </a> </li> <li class=md-nav__item> <a href=#fork class=md-nav__link> <span class=md-ellipsis> Що таке системний виклик fork? </span> </a> </li> <li class=md-nav__item> <a href=#- class=md-nav__link> <span class=md-ellipsis> Для яких завдань варто використовувати потоки, для яких - процеси, а для яких - асинхронність? </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../interpreter/ class=md-nav__link> <span class=md-ellipsis> Interpreter </span> </a> </li> <li class=md-nav__item> <a href=../functional_programming/ class=md-nav__link> <span class=md-ellipsis> Functional Programming </span> </a> </li> <li class=md-nav__item> <a href=../standard_library/ class=md-nav__link> <span class=md-ellipsis> Standard Library </span> </a> </li> <li class=md-nav__item> <a href=../python_packages/ class=md-nav__link> <span class=md-ellipsis> Python Packages </span> </a> </li> <li class=md-nav__item> <a href=../coding/ class=md-nav__link> <span class=md-ellipsis> Coding </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../python_framework/ class="md-nav__link "> <span class=md-ellipsis> Python Framework </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Python Framework </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../python_framework/django/ class=md-nav__link> <span class=md-ellipsis> Django </span> </a> </li> <li class=md-nav__item> <a href=../../python_framework/drf/ class=md-nav__link> <span class=md-ellipsis> DRF </span> </a> </li> <li class=md-nav__item> <a href=../../python_framework/fast_api/ class=md-nav__link> <span class=md-ellipsis> Fast API </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../computer_science/ class="md-nav__link "> <span class=md-ellipsis> Computer Science </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Computer Science </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../computer_science/oop/ class=md-nav__link> <span class=md-ellipsis> OOP </span> </a> </li> <li class=md-nav__item> <a href=../../computer_science/programming_principles/ class=md-nav__link> <span class=md-ellipsis> Programming Principles </span> </a> </li> <li class=md-nav__item> <a href=../../computer_science/solid/ class=md-nav__link> <span class=md-ellipsis> SOLID </span> </a> </li> <li class=md-nav__item> <a href=../../computer_science/data_structures/ class=md-nav__link> <span class=md-ellipsis> Data Structures </span> </a> </li> <li class=md-nav__item> <a href=../../computer_science/algorithmes/ class=md-nav__link> <span class=md-ellipsis> Algorithms </span> </a> </li> <li class=md-nav__item> <a href=../../computer_science/computer_science/ class=md-nav__link> <span class=md-ellipsis> Computer Science </span> </a> </li> <li class=md-nav__item> <a href=../../computer_science/testing/ class=md-nav__link> <span class=md-ellipsis> Testing </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <div class="md-nav__link md-nav__container"> <a href=../../web_development/ class="md-nav__link "> <span class=md-ellipsis> Web Development </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Web Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../web_development/http/ class=md-nav__link> <span class=md-ellipsis> HTTP </span> </a> </li> <li class=md-nav__item> <a href=../../web_development/rest_soap/ class=md-nav__link> <span class=md-ellipsis> REST SOAP </span> </a> </li> <li class=md-nav__item> <a href=../../web_development/rpc/ class=md-nav__link> <span class=md-ellipsis> RPC </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <div class="md-nav__link md-nav__container"> <a href=../../infrastructure/ class="md-nav__link "> <span class=md-ellipsis> Infrastructure </span> </a> <label class="md-nav__link " for=__nav_6 id=__nav_6_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../infrastructure/sql/ class=md-nav__link> <span class=md-ellipsis> SQL </span> </a> </li> <li class=md-nav__item> <a href=../../infrastructure/database/ class=md-nav__link> <span class=md-ellipsis> Database </span> </a> </li> <li class=md-nav__item> <a href=../../infrastructure/mq/ class=md-nav__link> <span class=md-ellipsis> MQ </span> </a> </li> <li class=md-nav__item> <a href=../../infrastructure/docker/ class=md-nav__link> <span class=md-ellipsis> Docker </span> </a> </li> <li class=md-nav__item> <a href=../../infrastructure/kubernates/ class=md-nav__link> <span class=md-ellipsis> Kubernates </span> </a> </li> <li class=md-nav__item> <a href=../../infrastructure/server/ class=md-nav__link> <span class=md-ellipsis> Server </span> </a> </li> <li class=md-nav__item> <a href=../../infrastructure/aws/ class=md-nav__link> <span class=md-ellipsis> AWS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <div class="md-nav__link md-nav__container"> <a href=../../architecture/ class="md-nav__link "> <span class=md-ellipsis> Architecture </span> </a> <label class="md-nav__link " for=__nav_7 id=__nav_7_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/architecture_patterns/ class=md-nav__link> <span class=md-ellipsis> Architecture Patterns </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/ddd/ class=md-nav__link> <span class=md-ellipsis> DDD </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/system_design/ class=md-nav__link> <span class=md-ellipsis> System Design </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <div class="md-nav__link md-nav__container"> <a href=../../development/ class="md-nav__link "> <span class=md-ellipsis> Development </span> </a> <label class="md-nav__link " for=__nav_8 id=__nav_8_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../development/git/ class=md-nav__link> <span class=md-ellipsis> Git </span> </a> </li> <li class=md-nav__item> <a href=../../development/ci_cd/ class=md-nav__link> <span class=md-ellipsis> CI/CD </span> </a> </li> <li class=md-nav__item> <a href=../../development/sdlc/ class=md-nav__link> <span class=md-ellipsis> SDLC </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_9> <div class="md-nav__link md-nav__container"> <a href=../../frontend/ class="md-nav__link "> <span class=md-ellipsis> Front-end </span> </a> <label class="md-nav__link " for=__nav_9 id=__nav_9_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_9_label aria-expanded=false> <label class=md-nav__title for=__nav_9> <span class="md-nav__icon md-icon"></span> Front-end </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../frontend/front_end/ class=md-nav__link> <span class=md-ellipsis> Front End </span> </a> </li> <li class=md-nav__item> <a href=../../frontend/javascript/ class=md-nav__link> <span class=md-ellipsis> JavaScript </span> </a> </li> <li class=md-nav__item> <a href=../../frontend/dom/ class=md-nav__link> <span class=md-ellipsis> DOM </span> </a> </li> <li class=md-nav__item> <a href=../../frontend/framework/ class=md-nav__link> <span class=md-ellipsis> Framework </span> </a> </li> <li class=md-nav__item> <a href=../../frontend/html/ class=md-nav__link> <span class=md-ellipsis> HTML </span> </a> </li> <li class=md-nav__item> <a href=../../frontend/css/ class=md-nav__link> <span class=md-ellipsis> CSS </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#gil class=md-nav__link> <span class=md-ellipsis> GIL, потоки, процеси </span> </a> <nav class=md-nav aria-label="GIL, потоки, процеси"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#thread-process class=md-nav__link> <span class=md-ellipsis> Що таке потік (Thread)? Що таке процес (Process)? </span> </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> В чому відмінність потоків від процесів </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> Недоліки потоків </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> Які існують способи синхронізації процесів та потоків ? Як передавати інформацію з одного процесу до іншого? </span> </a> </li> <li class=md-nav__item> <a href=#race-condition class=md-nav__link> <span class=md-ellipsis> Що таке гонка (race condition)? Як з нею боротися? </span> </a> </li> <li class=md-nav__item> <a href=#gil_1 class=md-nav__link> <span class=md-ellipsis> Що таке GIL? Які проблеми в нього є? </span> </a> </li> <li class=md-nav__item> <a href=#gil-i-gc class=md-nav__link> <span class=md-ellipsis> GIL i GC </span> </a> </li> <li class=md-nav__item> <a href=#python class=md-nav__link> <span class=md-ellipsis> Як реалізовано багатопотоковість у Python </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> Життєвий цикл треда </span> </a> </li> <li class=md-nav__item> <a href=#threadpool-threadpool class=md-nav__link> <span class=md-ellipsis> Для чого використовують ThreadPool? Як виділяються та повертаються потоки в ThreadPool? </span> </a> </li> <li class=md-nav__item> <a href=#thread-local class=md-nav__link> <span class=md-ellipsis> Як працює thread local? </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> Які завдання добре паралеляться, а які погано </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> Що таке блокуючі операції </span> </a> </li> <li class=md-nav__item> <a href=#100 class=md-nav__link> <span class=md-ellipsis> Потрібно обчислити 100 рівнянь. Робити це у потоках або ні </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> Що таке грінлети. Загальне поняття. Приклади реалізацій </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> Сигнали та планувальники потоків </span> </a> </li> <li class=md-nav__item> <a href=#fork class=md-nav__link> <span class=md-ellipsis> Що таке системний виклик fork? </span> </a> </li> <li class=md-nav__item> <a href=#- class=md-nav__link> <span class=md-ellipsis> Для яких завдань варто використовувати потоки, для яких - процеси, а для яких - асинхронність? </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>GIL Threads Processes</h1> <h3 id=gil>GIL, потоки, процеси<a class=headerlink href=#gil title="Permanent link">⚑</a></h3> <h4 id=thread-process>Що таке потік (Thread)? Що таке процес (Process)?<a class=headerlink href=#thread-process title="Permanent link">⚑</a></h4> <p><strong>Потік</strong> - це легкий підпроцес, що існує в межах основного процесу і може виконувати паралельні задачі. Кожен потік має свій стек викликів, але поділяє адресний простір, купу та регістри процесора з іншими потоками в рамках процесу. Потоки дозволяють програмі виконувати багатозадачні операції, розділюючи I/O завдання між різними потоками для збільшення продуктивності. У Python, для роботи з потоками можна використовувати модуль <code>threading</code>.</p> <p><strong>Процес</strong> - це незалежний виконуваний екземпляр програми, який має свою власну пам'ять та ресурси (файлові дескриптори, незалежні стеки викликів, купи та регістри процесора) і виконує код незалежно від інших процесів. Кожен процес має власний ідентифікатор процесу (PID) та виконується в окремому розділі пам'яті. У Python, для роботи з процесами можна використовувати модуль <code>multiprocessing</code>. Процеси є корисними для використання багатоядерних систем, оскільки кожен процес може працювати на власному ядрі процесора, що підвищує продуктивність програм. Особливо у випадку Python, де через GIL багатозадачність не дає справжнього паралелізму.</p> <p><em>Links</em></p> <ul> <li><a href=https://dou.ua/forums/topic/52887/ >Python без блокувань. Як працюють потоки - dou.ua</a></li> <li><a href=https://dou.ua/forums/topic/53004/ >Розділяй і володарюй. Як працюють процеси в Python - dou.ua</a></li> </ul> <h4 id=_1>В чому відмінність потоків від процесів<a class=headerlink href=#_1 title="Permanent link">⚑</a></h4> <p>Потоки історично з'явились пізніше процесів, і в Linux вони реалізовані однією і тією ж структурою даних, відомою як "таск" (Task). Для ядра Лінуксу немає різниці між потоком і процесом - потоки та процеси розглядаються як завдання (tasks). Тобто для створення того та іншого використовується єдина структура даних, де відмінність тільки в тому, що у треда буде встановлений TID, та декілька інших полей, які залежать від аргументів переданих до fork/clone викликів. CFS (Completely Fair Scheduler) та новий EEVDF (Earliest Eligible Virtual Deadline First) — планувальники, які використовуються для керування розподілом процесорного часу між завданнями в операційній системі - сприймають процеси та треди просто як "таски", тобто як абстракції завдань, тобто одиниці роботи, що потребують часу процесора. Вони не розрізняють тип цих завдань, а лише розподіляють час між ними залежно від заданих правил і алгоритмів.</p> <p>Основна відмінність полягає у розділенні пам'яті. Процеси є незалежними один від одного, мають окремі адресні простори, ідентифікатори та ресурси. Потоки виконуються у спільному адресному просторі, мають спільний доступ до пам'яті, змінних, завантажених модулів. Можна визначити змінну, і всі потоки її можуть бачити. А процеси такої можливості позбавлені і нам потрібно процеси якось зв'язувати.</p> <p>Створення та знищення процесів може бути важким процесом, оскільки вони вимагають виділення окремих ресурсів. IPC (Inter-Process Communication) — це механізм, який дозволяє процесам взаємодіяти між собою, обмінюватися даними та координувати виконання. </p> <p>Таким чином потоки є більш легкими, між ними швидше перемикається контекст.</p> <p><em>Links</em></p> <ul> <li><a href=https://foxminded.ua/potoky-python/ >Що таке потоки та процеси в Python - Foxminded.ua</a></li> <li><a href=https://habr.com/ru/articles/40227/ >https://habr.com/ru/articles/40227/</a></li> </ul> <h4 id=_2>Недоліки потоків<a class=headerlink href=#_2 title="Permanent link">⚑</a></h4> <p><strong>Потоки складні</strong> При багатопоточному виконанні коду кожен з потоків має одночасний доступ до даних, що може призвести до неочікуваних результатів через проблему гонки потоків. Наприклад один потік читає значення 10, збільшує його на 1 і записує 11, інший потік читає те ж значення 10, також інкрементує його, отримавши 11. У результаті очікуване значення — 12, але ми отримали 11.</p> <p>Помилки (баги) потоків і стан гонки (race conditions) у потокових програмах є найскладнішими типами помилок для виправлення. Потоки - це інструмент низького рівня, яким потрібно керувати вручну. Оскільки оптимальна кількість потоків для програми може змінюватися динамічно залежно від поточного завантаження системи та апаратного забезпечення, реалізація правильного рішення з допомогою потоків стає надзвичайно складною, якщо не неможливою. Крім того, механізми синхронізації, які зазвичай використовуються з потоками, додають складності та ризику в проєктування програмного забезпечення без будь-яких гарантій покращення продуктивності. З досвідом можливо розробляти нове програмне забезпечення, яке менш схильне до цих проблем, але у дуже складній програмі можлива ситуація, що ці проблеми буде неможливо виправити навіть експертам.</p> <p><strong>Потоки ресурсомісткі</strong></p> <p>Потоки вимагають додаткових ресурсів операційної системи для створення, таких як попередньо виділене, стекове місце, яке споживає віртуальну пам'ять процесу відразу. Це була велика проблема з 32-бітними операційними системами, оскільки адресний простір на процес обмежений 3 ГБ. Нині, з широкою доступністю 64-бітних операційних систем, віртуальна пам'ять вже не така цінна, як раніше (адресний простір для віртуальної пам'яті зазвичай 48 біт; тобто 256 Тіб). Але все-одно, потоки ресурсомісткі для програми (та системи) в плані використання пам'яті та продуктивності. Кожен потік вимагає виділення пам'яті як в адресному просторі ядра, так і в адресному просторі програми. Основні структури, необхідні для керування потоком та координації його планування, зберігаються в ядрі, використовуючи провідну пам'ять. Стек потоку та дані потоку зберігаються в адресному просторі програми. Більшість цих структур створюються та ініціалізуються при першому створенні потоку - процес, який може бути відносно дорогим через необхідність взаємодії з ядром. Однопотокові корутини не мають цих проблем і є набагато кращою альтернативою для одночасного введення-виведення.</p> <p><strong>Потоки можуть впливати на пропускну здатність</strong></p> <p>На дуже високих рівнях конкурентності (наприклад, &gt; 5000 потоків) може виникнути вплив на пропускну здатність через витрати на перемикання контекстів, за умови, що вдасться налаштувати операційну систему для створення такої кількості потоків. Також, якщо програма буде мати занадто багато Locks - код може почати виконуватись послідовно.</p> <p><strong>Потоки негнучкі</strong></p> <p>Операційна система постійно ділить процесорний час між усіма потоками, незалежно від того, чи готовий потік виконувати роботу. Наприклад, потік може чекати дані на сокеті, але планувальник ОС може все одно перемикатися на цей потік і з нього тисячі разів до того, як потрібно буде виконати якусь реальну роботу. (У асинхронному світі виклик системи <code>select()</code> використовується для перевірки, чи потрібна корутині, що очікує на сокеті, черга; якщо ні, ця корутина навіть не пробуджується, повністю уникаючи витрат на перемикання.)</p> <h4 id=_3>Які існують способи синхронізації процесів та потоків ? Як передавати інформацію з одного процесу до іншого?<a class=headerlink href=#_3 title="Permanent link">⚑</a></h4> <p>Синхронізація процесів і потоків у Python досягається через механізми, які забезпечують контроль над доступом до спільних ресурсів, а також дозволяють координувати виконання задач. </p> <ul> <li><strong>Блокування (Locks):</strong> <code>threading.Lock</code> або <code>multiprocessing.Lock</code> дозволяє обмежувати доступ до ресурсу лише одному потоку чи процесу в будь-який момент часу. Може призвести до взаємного блокування (deadlock).</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>class</span><span class=w> </span><span class=nc>Counter</span><span class=p>:</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>        <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>    <span class=k>def</span><span class=w> </span><span class=nf>increase</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>            <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>    <span class=o>...</span>
</span></code></pre></div> <p>Deadlock</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=k>class</span><span class=w> </span><span class=nc>DeadLockExample</span><span class=p>:</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>    <span class=k>def</span><span class=w> </span><span class=nf>outer_method</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Зовнішній метод залоковано&#39;</span><span class=p>)</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>            <span class=bp>self</span><span class=o>.</span><span class=n>inner_method</span><span class=p>()</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>    <span class=k>def</span><span class=w> </span><span class=nf>inner_method</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>        <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>lock</span><span class=p>:</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Внутрішній метод залоковано&#39;</span><span class=p>)</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=n>example</span> <span class=o>=</span> <span class=n>DeadLockExample</span><span class=p>()</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=n>thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>example</span><span class=o>.</span><span class=n>outer_method</span><span class=p>)</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=n>thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></code></pre></div> <ul> <li><strong>RLocks (Reentrant Locks):</strong> Дозволяють одному і тому ж потоку повторно захоплювати блокування без блокування самого себе. Вирішує проблему deadlock. <code>RLock</code> відстежує кількість разів, коли потік захопив блокування, і дозволяє його відпустити лише після відповідної кількості <code>release()</code>. <ul> <li>Перший раз <code>acquire()</code> отримує блокування. </li> <li>Кожен наступний <code>acquire()</code> просто збільшує лічильник захоплень. </li> <li><code>release()</code> зменшує лічильник, але звільняє Lock тільки тоді, коли лічильник доходить до нуля.</li> </ul> </li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=n>lock</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span>  <span class=c1># Acquire the lock</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=n>lock</span><span class=o>.</span><span class=n>release</span><span class=p>()</span>  <span class=c1># Release the lock</span>
</span></code></pre></div> <ul> <li><strong>Семафори (Semaphores):</strong> <code>threading.Semaphore</code> дозволяє обмежувати доступ до ресурсу певною кількістю потоків. Для процесів використовується <code>multiprocessing.Semaphore</code>.<ul> <li>коли потік захоплює семафор, лічильник зменшується</li> <li>якщо лічильник дорівнює нулю, потік чекає, доки семафор не звільниться</li> <li>коли потік звільняє семафор, лічильник збільшується, і інший потік може отримати доступ</li> </ul> </li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=k>def</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    <span class=k>with</span> <span class=n>sem</span><span class=p>:</span>  
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> отримав доступ&#39;</span><span class=p>)</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> звільнив доступ&#39;</span><span class=p>)</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=n>sem</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Semaphore</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Thread-</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,))</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)]</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span> <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></code></pre></div> <ul> <li><strong>Події (Events):</strong> <code>threading.Event</code> або <code>multiprocessing.Event</code> використовуються для координації потоків або процесів через сигнали. Один потік повинен чекати на дозвіл від іншого перед початком роботи. Потік, що чекає, викликає <code>wait()</code>, і він заблокований, поки інший потік не викличе <code>set()</code>, сигналізуючи, що можна продовжувати. <code>Event</code> зручно використовувати, коли необхідно контролювати запуск потоків або координацію їх виконання, наприклад, у ситуаціях, коли потік має почати роботу лише після отримання певного сигналу.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=n>event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=k>def</span><span class=w> </span><span class=nf>worker</span><span class=p>():</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Waiting for signal&#39;</span><span class=p>)</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=n>event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span>  <span class=c1># Waits for set()</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Thread started!&#39;</span><span class=p>)</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=n>thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>)</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=n>thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=n>event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>  <span class=c1># Grants the thread permission to work</span>
</span></code></pre></div> <ul> <li><strong>Черги (Queues):</strong> <code>queue.Queue</code> для потоків і <code>multiprocessing.Queue</code> для процесів дозволяють обмінюватися даними між потоками чи процесами в безпечний спосіб. Черга працює за принципом FIFO (First In, First Out) — перший доданий елемент буде першим витягнутий.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kn>import</span><span class=w> </span><span class=nn>queue</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=k>class</span><span class=w> </span><span class=nc>ProducerConsumer</span><span class=p>:</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num_consumers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span> <span class=n>num_elements</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>):</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>q</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=n>Queue</span><span class=p>()</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_producer</span><span class=p>)</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>        <span class=bp>self</span><span class=o>.</span><span class=n>consumer_threads</span> <span class=o>=</span> <span class=p>(</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_consumer</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_consumers</span><span class=p>))</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>        <span class=bp>self</span><span class=o>.</span><span class=n>num_elements</span> <span class=o>=</span> <span class=n>num_elements</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>    <span class=k>def</span><span class=w> </span><span class=nf>_producer</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_elements</span><span class=p>):</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>            <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>  <span class=c1># Adds an element to the queue</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Added </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>  <span class=c1># Simulates work</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>    <span class=k>def</span><span class=w> </span><span class=nf>_consumer</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>empty</span><span class=p>():</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>            <span class=n>item</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>  <span class=c1># Retrieves an element</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Received </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>            <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>task_done</span><span class=p>()</span>  <span class=c1># Marks the item as processed</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># Simulates processing</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>    <span class=k>def</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>  <span class=c1># Gives the producer time to add data</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>        <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>consumer_threads</span><span class=p>:</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>            <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a>        <span class=bp>self</span><span class=o>.</span><span class=n>producer_thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>  <span class=c1># Waits for the producer to finish</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a>        <span class=bp>self</span><span class=o>.</span><span class=n>q</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>  <span class=c1># Waits until all elements are processed</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a>    <span class=n>pc</span> <span class=o>=</span> <span class=n>ProducerConsumer</span><span class=p>()</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a>    <span class=n>pc</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></code></pre></div> <ul> <li><strong>Бар'єри (Barriers):</strong> <code>threading.Barrier</code> використовується для синхронізації групи потоків, які повинні досягти певного пункту перед продовженням роботи.</li> </ul> <p>Для передачі інформації між процесами в Python найчастіше використовуються наступні способи - <strong>Черги (Queues):</strong> Черги з модуля <code>multiprocessing</code> дозволяють процесам безпечно обмінюватися даними. <code>multiprocessing.Queue()</code> працює через пайпи (<code>multiprocessing.Pipe</code>). Кожен процес у Python має власний простір пам’яті, тож щоб розв'язати цю проблему <code>multiprocessing.Queue()</code> автоматично серіалізує дані перед передачею через <code>pickle</code>. Це дозволяє ефективно працювати з незалежними процесами, які виконуються на різних ядрах CPU, проте серіалізація додає накладні витрати, особливо при передачі великих об’єктів.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kn>from</span><span class=w> </span><span class=nn>multiprocessing</span><span class=w> </span><span class=kn>import</span> <span class=n>Process</span><span class=p>,</span> <span class=n>Queue</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=k>def</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>q</span><span class=p>):</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    <span class=n>q</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=s2>&quot;Hello from process&quot;</span><span class=p>)</span>  <span class=c1># Send a message to the queue</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>    <span class=n>q</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>()</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>    <span class=n>p</span> <span class=o>=</span> <span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>q</span><span class=p>,))</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    <span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>    <span class=nb>print</span><span class=p>(</span><span class=n>q</span><span class=o>.</span><span class=n>get</span><span class=p>())</span>  <span class=c1># Receive a message from the queue</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>    <span class=n>p</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></code></pre></div> <ul> <li><strong>Канали (Pipes):</strong> Використовуються для прямого зв'язку між двома процесами. Пайпи в контексті міжпроцесної взаємодії (IPC) — це механізм передачі даних між процесами через спеціальні канали зв’язку. Пайп створюється у вигляді двох кінців — один процес записує дані <code>send()</code>, а інший читає <code>recv()</code>. Це забезпечує односторонній або двосторонній зв’язок між процесами. За замовчуванням пайп працює в режимі "point-to-point", тобто дані можуть передаватися лише між двома процесами. Якщо використовується двосторонній зв’язок, то обидва процеси можуть як відправляти, так і отримувати дані.</li> <li>Механізм роботи пайпів базується на файлових дескрипторах, де один кінець записує дані в канал, а інший читає з нього. На низькому рівні пайпи використовують системні виклики операційної системи для створення потоків зв'язку між процесами, що дозволяє ефективно передавати навіть великі об'єкти. Проте дані в пайпі можуть бути пошкоджені, якщо два процеси одночасно спробують читати або записувати в один і той самий кінець каналу. Але якщо процеси працюють з різними кінцями пайпу одночасно — дані будуть у безпеці.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kn>from</span><span class=w> </span><span class=nn>multiprocessing</span><span class=w> </span><span class=kn>import</span> <span class=n>Process</span><span class=p>,</span> <span class=n>Pipe</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=k>def</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>conn</span><span class=p>):</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    <span class=n>conn</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;Hello from worker&quot;</span><span class=p>)</span>  <span class=c1># Send a message through the pipe</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=n>parent_conn</span><span class=p>,</span> <span class=n>child_conn</span> <span class=o>=</span> <span class=n>Pipe</span><span class=p>()</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>    <span class=n>p</span> <span class=o>=</span> <span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>child_conn</span><span class=p>,))</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>    <span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>    <span class=nb>print</span><span class=p>(</span><span class=n>parent_conn</span><span class=o>.</span><span class=n>recv</span><span class=p>())</span>  <span class=c1># Receive a message from the pipe</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>    <span class=n>p</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></code></pre></div> <ul> <li><strong>Спільна пам'ять (Shared Memory):</strong> Через <code>multiprocessing.Value</code> або <code>multiprocessing.Array</code> можна ділитися даними між процесами. Дозволяє процесам обмінюватися даними через спільний простір у пам’яті без необхідності серіалізації та передачі через пайпи чи черги. Це робить її значно швидшою, оскільки дані передаються напряму без копіювання між процесами.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kn>from</span><span class=w> </span><span class=nn>multiprocessing</span><span class=w> </span><span class=kn>import</span> <span class=n>Process</span><span class=p>,</span> <span class=n>Value</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=k>def</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>shared_value</span><span class=p>):</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>    <span class=n>shared_value</span><span class=o>.</span><span class=n>value</span> <span class=o>+=</span> <span class=mi>1</span>  <span class=c1># Modify shared value</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>    <span class=n>shared_value</span> <span class=o>=</span> <span class=n>Value</span><span class=p>(</span><span class=s1>&#39;i&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># Integer value in shared memory</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>    <span class=n>processes</span> <span class=o>=</span> <span class=p>[</span><span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>shared_value</span><span class=p>,))</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)]</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>    <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>processes</span><span class=p>:</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>        <span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>    <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>processes</span><span class=p>:</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>        <span class=n>p</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>    <span class=nb>print</span><span class=p>(</span><span class=n>shared_value</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>  <span class=c1># Output: 5</span>
</span></code></pre></div> <ul> <li><strong>Менеджери (Managers):</strong> Дають змогу створювати об’єкти (списки, словники тощо) для спільного використання між процесами. <code>Manager</code> забезпечує високорівневий інтерфейс, який створює серверний процес, що дозволяє спільно використовувати Python-об’єкти (списки, словники, черги тощо) між різними процесами. Менеджер автоматично синхронізує доступ до цих об’єктів і забезпечує їхню безпеку. Ключова перевага <code>Manager</code> полягає в тому, що він дозволяє працювати зі звичними Python-об’єктами, не турбуючись про механіку блокування чи передачі даних між процесами. Всі операції над такими об'єктами відбуваються через проксі, який керується <code>Manager</code>. Коли ми створюємо об’єкт через <code>Manager</code>, він фактично зберігається у серверному процесі, а кожен клієнтський процес отримує доступ до цього об’єкта через проксі. Завдяки цьому зміни, внесені одним процесом, одразу видно іншим.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=kn>from</span><span class=w> </span><span class=nn>multiprocessing</span><span class=w> </span><span class=kn>import</span> <span class=n>Manager</span><span class=p>,</span> <span class=n>Process</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>def</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>shared_dict</span><span class=p>):</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>    <span class=n>shared_dict</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;value&quot;</span>  <span class=c1># Update shared dictionary</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>    <span class=n>manager</span> <span class=o>=</span> <span class=n>Manager</span><span class=p>()</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>    <span class=n>shared_dict</span> <span class=o>=</span> <span class=n>manager</span><span class=o>.</span><span class=n>dict</span><span class=p>()</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>    <span class=n>p</span> <span class=o>=</span> <span class=n>Process</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>shared_dict</span><span class=p>,))</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>    <span class=n>p</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>    <span class=n>p</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>    <span class=nb>print</span><span class=p>(</span><span class=n>shared_dict</span><span class=p>)</span>  <span class=c1># Output: {&#39;key&#39;: &#39;value&#39;}</span>
</span></code></pre></div> <p><em>Links</em></p> <ul> <li><a href=https://superfastpython.com/multiprocessing-share-large-data-between-processes/ >https://superfastpython.com/multiprocessing-share-large-data-between-processes/</a></li> </ul> <h4 id=race-condition>Що таке гонка (race condition)? Як з нею боротися?<a class=headerlink href=#race-condition title="Permanent link">⚑</a></h4> <p><strong>Гонка (race condition)</strong> — це помилка в програмі, яка виникає, коли результат виконання коду залежить від того, як чергуються операції кількох потоків чи процесів, що одночасно звертаються до спільного ресурсу. Такі ситуації можуть призводити до некоректної поведінки програми, непередбачуваних результатів або навіть до аварійного завершення роботи.</p> <p>Гонка виникає, якщо: - Декілька потоків чи процесів мають спільний доступ до ресурсу (наприклад, змінної або файлу). - Відсутні засоби синхронізації, які гарантують коректний порядок виконання операцій над ресурсом.</p> <p>Проблеми гонки потоків існує для версій, молодших за Python 3.10.x, для інших — все працює як належить. У Python 3.10 було введено оптимізацію, яка змінила спосіб роботи GIL. Раніше GIL міг звільнятися і захоплюватися на будь-якій байткод-інструкції, але тепер це відбувається лише на певних «спеціальних» байткод-інструкціях, які називаються <code>eval breakers</code>.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>  
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=k>class</span><span class=w> </span><span class=nc>Counter</span><span class=p>:</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>    <span class=k>def</span><span class=w> </span><span class=nf>increase</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=k>def</span><span class=w> </span><span class=nf>work</span><span class=p>(</span><span class=n>counter</span><span class=p>:</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>operations_count</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>operations_count</span><span class=p>):</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>        <span class=n>counter</span><span class=o>.</span><span class=n>increase</span><span class=p>()</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=k>def</span><span class=w> </span><span class=nf>run_threads</span><span class=p>(</span><span class=n>counter</span><span class=p>:</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>count</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>operations_count</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>    <span class=n>threads</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>count</span><span class=p>):</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>        <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>work</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>counter</span><span class=p>,</span> <span class=n>operations_count</span><span class=p>))</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a>        <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>        <span class=n>threads</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a>        <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a>    <span class=n>threads_count</span> <span class=o>=</span> <span class=mi>10</span>
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a>    <span class=n>operations_per_thread_count</span> <span class=o>=</span> <span class=mi>1_000_000</span>
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a>
</span><span id=__span-10-29><a id=__codelineno-10-29 name=__codelineno-10-29 href=#__codelineno-10-29></a>    <span class=n>counter</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>()</span>
</span><span id=__span-10-30><a id=__codelineno-10-30 name=__codelineno-10-30 href=#__codelineno-10-30></a>    <span class=n>run_threads</span><span class=p>(</span><span class=n>counter</span><span class=p>,</span> <span class=n>threads_count</span><span class=p>,</span> <span class=n>operations_per_thread_count</span><span class=p>)</span>
</span><span id=__span-10-31><a id=__codelineno-10-31 name=__codelineno-10-31 href=#__codelineno-10-31></a>
</span><span id=__span-10-32><a id=__codelineno-10-32 name=__codelineno-10-32 href=#__codelineno-10-32></a>    <span class=n>excepted_result</span> <span class=o>=</span> <span class=n>threads_count</span> <span class=o>*</span> <span class=n>operations_per_thread_count</span>
</span><span id=__span-10-33><a id=__codelineno-10-33 name=__codelineno-10-33 href=#__codelineno-10-33></a>    <span class=n>actual_result</span> <span class=o>=</span> <span class=n>counter</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-10-34><a id=__codelineno-10-34 name=__codelineno-10-34 href=#__codelineno-10-34></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Expected: </span><span class=si>{</span><span class=n>excepted_result</span><span class=si>}</span><span class=s1>, actual: </span><span class=si>{</span><span class=n>actual_result</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></code></pre></div> <p>Коли Python виконує код, він перекладає його у набір байткод-інструкцій. Якщо спростити, для нашого прикладу це виглядає приблизно так:</p> <ol> <li><code>LOAD_ATTR</code> — завантажує значення змінної <code>value</code></li> <li><code>LOAD_CONST</code> — завантажує константу 1</li> <li><code>BINARY_OP</code> — додає 1 до значення <code>value</code></li> <li><code>STORE_ATTR</code> — зберігає результат у змінну <code>value</code></li> <li><code>JUMP_BACKWARD</code> — перемикає на наступну ітерацію</li> </ol> <p>У 1-4 інструкціях немає <code>eval breakers</code>, тобто інструкцій, які змушують GIL звільнятися і захоплюватися знову. Це означає, що вся ця послідовність (тобто операція додавання) виконується атомарно — без втручання інших потоків. Таким чином, кожна ітерація виконується (майже) без гонки потоків.</p> <p>Інструкції, які можуть (але не обов’язково) викликати звільнення GIL, це <code>JUMP_BACKWARD</code> (або <code>JUMP_ABSOLUTE</code>, залежно від версій Python), яка виконує перехід на початок циклу і може перевіряти GIL у довгих циклах, або <code>CALL</code> (у версіях до Python 3.11 — <code>CALL_FUNCTION</code>), що може звільнити GIL у випадках, коли викликається функція C, I/O або складні обчислення. Байт-код інструкції для програми можна побачити за допомогою модуля <code>dis</code> у Python, що використовується для дизасемблювання (розбору) байткоду, який виконує інтерпретатор Python.</p> <p>Але якщо в коді між 1-4 інструкціями додасться нова, що викличе <code>eval breakers</code>, який може звільнити GIL, то проблема розірвання цілісної операції додавання перемиканням потоків повернеться.</p> <p>Як боротися з гонкою</p> <ul> <li>Використовувати блокування (<code>threading.Lock</code>): Блокування дозволяє гарантувати, що лише один потік чи процес може змінювати ресурс у певний момент.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=n>lock</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=k>def</span><span class=w> </span><span class=nf>increment</span><span class=p>():</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>    <span class=k>global</span> <span class=n>counter</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100000</span><span class=p>):</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>        <span class=k>with</span> <span class=n>lock</span><span class=p>:</span>  <span class=c1># Ensure only one thread modifies the counter</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>            <span class=n>counter</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>increment</span><span class=p>)</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>)]</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>    <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>    <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=nb>print</span><span class=p>(</span><span class=n>counter</span><span class=p>)</span>  <span class=c1># Will be always 200000</span>
</span></code></pre></div> <ul> <li>Використовувати атомарні операції: У деяких випадках можна використовувати спеціальні функції або модулі для виконання атомарних операцій. Наприклад, <code>multiprocessing.Value</code> з atomic lock.</li> <li>Семафори: Якщо потрібно контролювати доступ до ресурсу для певної кількості потоків чи процесів.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=n>semaphore</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Semaphore</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># Maximum one thread in a critical section</span>
</span></code></pre></div> <ul> <li>Queue: Для передачі даних між потоками чи процесами краще використовувати безпечні черги (<code>queue.Queue</code> або <code>multiprocessing.Queue</code>), що автоматично забезпечують синхронізацію.</li> <li>Переосмислення архітектури програми: Уникнення спільного доступу до змінних, використання іммутабельних структур даних та передачі повідомлень замість спільного ресурсу.</li> <li>Глобальний блок інтерпретатора (GIL): У CPython GIL частково запобігає деяким видам гонок, але його наявність не означає, що гонки не можуть виникнути.</li> </ul> <p><em>Links</em></p> <ul> <li><a href="https://www.youtube.com/watch?v=Bv25Dwe84g0">Thinking about Concurrency, Raymond Hettinger, Python core developer</a></li> <li><a href=https://habr.com/ru/articles/764420/ >https://habr.com/ru/articles/764420/</a></li> </ul> <h4 id=gil_1>Що таке GIL? Які проблеми в нього є?<a class=headerlink href=#gil_1 title="Permanent link">⚑</a></h4> <p><em>Summary</em></p> <blockquote> <p><strong>GIL - Global Interpreter Lock</strong> - Глобальний блок інтерпретатора - це механізм, який регулює виконання потоків у межах інтерпретатора CPython, запобігаючи одночасному виконанню кількох потоків Python-коду. Він забезпечує безпеку доступу до пам’яті під час виконання інтерпретатора, але водночас створює значні обмеження для паралельного виконання обчислювальних задач. GIL — це не просто обмеження. Він є компромісом між продуктивністю, безпекою пам’яті та простотою реалізації інтерпретатора.</p> </blockquote> <p>В будь-який момент виконується лише один потік Python. GIL гарантує, що кожен потік має ексклюзивний доступ до змінних інтерпретатора (і відповідні виклики C-розширень працюють правильно). Хоча GIL значно спрощує розробку інтерпретатора та гарантує потокобезпечність багатьох базових операцій, він стає серйозним обмеженням для багатоядерних процесорів, оскільки лише один потік може виконувати Python-код у певний момент часу.</p> <p>GIL — це блокування, яке має бути захоплено перед будь-яким доступом до Python (не так важливо, чи це виконується Python-код або виклики Python C API).</p> <p>GIL необхідний для забезпечення безпеки пам’яті в Python та потокобезпечності загалом. Без GIL довелося б додатково синхронізувати доступ до кожного об’єкта у пам’яті, що суттєво ускладнило б код і зменшило б продуктивність однопоточних програм. Тому GIL також покращує продуктивність у сценаріях, де код виконується в одному потоці. Для однопоточних задач відсутність накладних витрат на синхронізацію робить виконання швидшим. Це особливо корисно для багатьох класичних сценаріїв використання Python, таких як обробка скриптів, автоматизація або створення вебсервісів.</p> <p>Також GIL робить розробку розширень на C набагато простішою. Багато бібліотек на C розраховують на те, що GIL захищає доступ до об’єктів Python. Це дозволяє бібліотекам уникати ручної синхронізації та працювати з об’єктами Python у безпечному середовищі.</p> <p>Принцип роботи простий. Потоки утримують GIL, поки вони виконуються. Однак, вони звільняють його при блокуванні для операцій введення-виведення. Кожного разу, коли поток змушений чекати, інші готові до виконання потоки отримують шанс запуститися.</p> <div class="language-c highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=n>PyObject</span><span class=o>*</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=nf>_PyEval_EvalFrameDefault</span><span class=p>(</span><span class=n>PyThreadState</span><span class=w> </span><span class=o>*</span><span class=n>tstate</span><span class=p>,</span><span class=w> </span><span class=n>PyFrameObject</span><span class=w> </span><span class=o>*</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>throwflag</span><span class=p>)</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=p>{</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>    </span><span class=c1>// оголошення локальних змінних тощо</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>    </span><span class=c1>// обчислювальний цикл</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>        </span><span class=c1>// eval_breaker повідомляє, чи потрібно призупинити виконання байт-коду, наприклад, якщо інший потік запросив GIL</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_Py_atomic_load_relaxed</span><span class=p>(</span><span class=n>eval_breaker</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=w>            </span><span class=c1>// eval_frame_handle_pending() призупиняє виконання байт-коду, звільняє GIL і знову очікує доступності GIL</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>eval_frame_handle_pending</span><span class=p>(</span><span class=n>tstate</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=w>                </span><span class=k>goto</span><span class=w> </span><span class=n>error</span><span class=p>;</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=w>        </span><span class=n>NEXTOPARG</span><span class=p>();</span><span class=w> </span><span class=c1>// отримати наступну інструкцію байт-коду</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>opcode</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=no>TARGET</span><span class=p>(</span><span class=no>NOP</span><span class=p>)</span><span class=w> </span><span class=err>{</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>                </span><span class=no>FAST_DISPATCH</span><span class=p>()</span><span class=err>;</span><span class=w> </span><span class=c1>// наступна ітерація</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=w>            </span><span class=err>}</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>            </span><span class=no>case</span><span class=w> </span><span class=no>TARGET</span><span class=p>(</span><span class=no>LOAD_FAST</span><span class=p>)</span><span class=w> </span><span class=err>{</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=w>                </span><span class=no>FAST_DISPATCH</span><span class=p>()</span><span class=err>;</span><span class=w> </span><span class=c1>// наступна ітерація</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=w>            </span><span class=err>}</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=w>            </span><span class=c1>// ще 117 блоків case, що відповідають усім можливим кодам операцій</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=w>        </span><span class=err>}</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=w>        </span><span class=c1>// обробка помилок</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=w>    </span><span class=err>}</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=w>    </span><span class=c1>// завершення</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=err>}</span>
</span></code></pre></div> <p>Функція <code>__PyEval_EvalFrameDefault_</code> відповідає за обробку байт-коду і виконання його інструкцій.</p> <p>Коли потік починає роботу, він захоплює GIL. Через певний час планувальник процесів вирішує, що поточний потік виконав достатньо роботи і передає управління наступному потоку. Потік №2 бачить, що GIL захоплений, тому він не продовжує роботу, а сам себе переводить у сплячий режим, уступаючи процесор потоку №1.</p> <p>Але потік не може утримувати GIL нескінченно. До версії Python 3.2 GIL перемикався кожні 100 тіків (машинних інструкцій). У пізніших версіях GIL може бути утримано потоком не більше 5 мс. Значення цього інтервалу можна змінити за допомогою функції <code>sys.setswitchinterval()</code>. GIL також звільняється, якщо потік здійснює системний виклик, працює з диском або мережею.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=k>def</span><span class=w> </span><span class=nf>run_io_task</span><span class=p>(</span><span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> почав I/O операцію&#39;</span><span class=p>)</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1> закінчив I/O операцію&#39;</span><span class=p>)</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>run_io_task</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Потік-</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,))</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>)]</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>    <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>    <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></code></pre></div> <p>Кожен потік викликає <code>time.sleep(2)</code> інструкцію, яка звільняє GIL. Поки один потік чекає завершення <code>sleep</code>, інші потоки можуть виконуватися. У результаті всі потоки працюють ефективно, і програма виконується швидше (приблизно 2 секунди), ніж при послідовному виконанні (приблизно 8 секунд).</p> <p>На глибокому рівні механізм роботи GIL реалізовано через примітиви синхронізації операційної системи. У CPython це зазвичай м’ютекси для блокування та семафори для сигналізації між потоками. У сучасних версіях Python (починаючи з Python 3.2) GIL реалізовано через м’ютекс і умови (pthreads condition variables) для підвищення продуктивності.</p> <p>Умовні змінні у цьому процесі використовуються для того, щоб потік, який очікує, міг бути розблокований лише за сигналом. Таке розблокування запобігає активному циклу очікування (busy waiting), що могло б надмірно навантажувати процесор. Але перемикання супроводжуються додатковими витратами, оскільки такі дії включають системні виклики та доступ до структур ядра ОС.</p> <p>Проблема полягає в тому, що через GIL далеко не всі завдання можуть бути вирішені у потоках. Навпаки, їх використання часто знижує продуктивність програми (у випадку CPU-bound завдань). Використання потоків вимагає контролю доступу до загальних ресурсів, таких як словники, файли, підключення до бази даних.</p> <ul> <li>GIL спрощує інтеграцію незахищених від багатопотоковості (non thread safe) бібліотек на C. Завдяки GIL у нас є так багато швидких модулів та зв'язків майже до всього.</li> <li>Бібліотекам на C доступний механізм керування GIL. Наприклад, NumPy звільняє його під час тривалих операцій.</li> </ul> <p>На практиці, GIL у Python робить непотрібною ідею використання потоків для паралелізму в обчислювальних задачах. Вони будуть працювати послідовно навіть на багатопроцесорній системі. У випадку CPU-bound задач програма не прискориться, а тільки сповільниться, оскільки тепер потокам доведеться поділити процесорний час навпіл. При цьому операції I/O GIL не сповільнює, оскільки перед системним викликом потік звільняє GIL.</p> <p>GIL існує лише в оригінальному інтерпретаторі CPython. </p> <p><em>Links</em></p> <ul> <li><a href=https://dou.ua/forums/topic/52787/ >GIL у Python. Ключ до стабільності чи ворог продуктивності - dou.ua</a></li> <li><a href=https://wiki.python.org/moin/GlobalInterpreterLock>GlobalInterpreterLock</a></li> <li><a href=https://habr.com/ru/post/84629/ >Как устроен GIL в Python</a></li> <li><a href="https://www.youtube.com/watch?v=fwzPF2JLoeU">Embracing the Global Interpreter Lock (GIL) - David Beazley</a></li> </ul> <h4 id=gil-i-gc>GIL i GC<a class=headerlink href=#gil-i-gc title="Permanent link">⚑</a></h4> <p>Кожен об'єкт у Python - це, насамперед, об'єкт, успадкований від базового класу PyObject. Цей самий PyObject містить всього два поля: <code>ob_refcnt</code> - кількість посилань, і <code>ob_type</code> - вказівник на інший об'єкт, тип даного об'єкта.</p> <p><code>ob_refcnt</code> - це лічильник посилань на конкретний екземпляр даного класу. Кожен раз, коли зберігаємо об'єкт в новій змінній, масиві і т.д. (тобто коли ми зберігаємо десь посилання на об'єкт), ми збільшуємо лічильник посилань на одиницю. Кожен раз, коли ми припиняємо використовувати змінну, видаляємо об'єкт з масиву і т.д. (тобто коли посилання на об'єкт видаляється), ми зменшуємо лічильник посилань на одиницю. Коли він доходить до 0 - об'єкт більше ніким не використовується і Python його видаляє (в тому числі поміщаючи блок, в якому розташовувався об'єкт, в список порожніх).</p> <p>При використанні кількох потоків кожен з них зможе мати доступ до лічильника посилань та змінювати його, інкрементуючи чи декрементуючи, під час виконання байт-коду Python, що неодмінно призведе до проблем з очищенням пам’яті. У результаті може статися ситуація, коли об’єкт, що ще має посилання, буде видалено чи навпаки — пам’ять буде перевантажено непотрібними об’єктами, що вже не використовуються.</p> <p>Тобто, лічильник посилань піддається проблемам у багатопотоковому середовищі. Стани гонки можуть призводити до некоректності оновлення цього лічильника з різних потоків. Щоб цього уникнути, CPython використовує GIL - Global Interpreter Lock. Кожен раз, коли відбувається робота з пам'яттю, GIL - як глобальний блок - перешкоджає виконанню цих дій одночасно з двох потоків. Він гарантує, що спершу відпрацює один, потім інший.</p> <h4 id=python>Як реалізовано багатопотоковість у Python<a class=headerlink href=#python title="Permanent link">⚑</a></h4> <p>Багатопотоковість реалізована за допомогою модуля Threading. Це нативні POSIX-потоки. Такі потоки виконуються на рівні операційної системи, а не віртуальною машиною.</p> <p>У Python всі потоки в одному процесі ділять єдиний простір пам’яті. Це означає, що всі потоки можуть читати та змінювати одні й ті ж змінні, об’єкти та ресурси. Тому немає потреби налаштовувати додаткові механізми для передачі інформації, оскільки потоки автоматично мають доступ до одних і тих же змінних. Це сприяє більш оптимальному використанню пам’яті, бо єдина пам’ять зменшує витрати на створення копій даних.</p> <p>Але через те, що кілька потоків одночасно мають доступ до однієї й тієї ж змінної, може виникнути конфлікт.</p> <p><em>Links</em></p> <ul> <li><a href=https://dou.ua/forums/topic/52887/ >Python без блокувань. Як працюють потоки - dou.ua</a></li> <li><a href=https://otus.ru/journal/threads-v-python/ >https://otus.ru/journal/threads-v-python/</a></li> <li><a href=https://realpython.com/intro-to-python-threading/ >https://realpython.com/intro-to-python-threading/</a></li> </ul> <h4 id=_4>Життєвий цикл треда<a class=headerlink href=#_4 title="Permanent link">⚑</a></h4> <ul> <li>Спочатку створюємо клас, який успадковує від класу <code>Thread</code> з модуля <code>threading</code>. В ньому перевизначаємо метод <code>run</code> . </li> <li>Створюємо екземпляр (instance) цього класу, викликаємо <code>start()</code>, який готує тред до виконання. Переводимо тред у стан виконання</li> <li>Можна викликати різні методи, наприклад, <code>sleep()</code> і <code>join()</code>, які переводять тред у режим очікування</li> <li>Коли режим очікування чи виконання припиняється, інші треди, які очікують, готуються до виконання</li> <li>Після завершення виконання тред зупиняється</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=kn>import</span><span class=w> </span><span class=nn>random</span>  
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=kn>import</span><span class=w> </span><span class=nn>time</span>  
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=kn>from</span><span class=w> </span><span class=nn>threading</span><span class=w> </span><span class=kn>import</span> <span class=n>Thread</span>  
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=k>class</span><span class=w> </span><span class=nc>MyThread</span><span class=p>(</span><span class=n>Thread</span><span class=p>):</span>  
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>  
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>  
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>  
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>    <span class=k>def</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>  
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>        <span class=n>amount</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>15</span><span class=p>)</span>  
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span>  
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a>        <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> is running&quot;</span>        <span class=nb>print</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>  
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=k>def</span><span class=w> </span><span class=nf>create_threads</span><span class=p>():</span>  
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>):</span>  
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a>        <span class=n>name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Thread #</span><span class=si>{</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>&quot;</span>  
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a>        <span class=n>my_thread</span> <span class=o>=</span> <span class=n>MyThread</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>  
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a>        <span class=n>my_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>  
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>  
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a>    <span class=n>create_threads</span><span class=p>()</span>
</span></code></pre></div> <h4 id=threadpool-threadpool>Для чого використовують ThreadPool? Як виділяються та повертаються потоки в ThreadPool?<a class=headerlink href=#threadpool-threadpool title="Permanent link">⚑</a></h4> <p><strong>ThreadPool</strong> — це пул потоків, який використовується для ефективного управління багатопоточністю. Він дозволяє обмежити кількість одночасно активних потоків, повторно використовувати вже створені потоки та знижувати накладні витрати на створення й знищення потоків.</p> <p>Використання <code>ThreadPool</code> дозволяє знизити витрати на створення/знищення потоків, оскільки замість створення нового потоку для кожного завдання, потоки використовуються повторно. Також він дозволяє обмежити кількість потоків, що одночасно виконують завдання, запобігаючи перевантаженню системи.</p> <p>Механізм роботи <code>ThreadPool</code> - <strong>Ініціалізація:</strong> - Пул створює певну кількість потоків (<code>N</code>) під час ініціалізації. Ці потоки знаходяться в стані очікування завдань. - Розмір пулу визначає максимальну кількість потоків, які можуть одночасно виконувати завдання. - <strong>Постановка завдання:</strong> - Завдання (функція чи об’єкт, що викликається) додається в чергу завдань пулу. - Потік із пулу бере завдання з черги і починає його виконувати. - <strong>Виконання завдань:</strong> - Кожен потік із пулу виконує одне завдання за раз. - Після завершення виконання потік не завершується, а повертається в пул, де очікує наступне завдання. - <strong>Закриття пулу:</strong> - Коли всі завдання завершені, і пул більше не потрібен, його закривають, що завершує всі потоки.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=kn>from</span><span class=w> </span><span class=nn>concurrent.futures</span><span class=w> </span><span class=kn>import</span> <span class=n>ThreadPoolExecutor</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=k>def</span><span class=w> </span><span class=nf>task</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Starting task </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>  <span class=c1># Simulate a long-running operation</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Task </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2> completed&quot;</span><span class=p>)</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&quot;Result of </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=k>with</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=k>as</span> <span class=n>executor</span><span class=p>:</span>  <span class=c1># Create a ThreadPool with 3 threads</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>    <span class=n>futures</span> <span class=o>=</span> <span class=p>[</span><span class=n>executor</span><span class=o>.</span><span class=n>submit</span><span class=p>(</span><span class=n>task</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>5</span><span class=p>)]</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a>    <span class=k>for</span> <span class=n>future</span> <span class=ow>in</span> <span class=n>futures</span><span class=p>:</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>        <span class=nb>print</span><span class=p>(</span><span class=n>future</span><span class=o>.</span><span class=n>result</span><span class=p>())</span>  <span class=c1># Blocks until the task is completed</span>
</span></code></pre></div> <h4 id=thread-local>Як працює thread local?<a class=headerlink href=#thread-local title="Permanent link">⚑</a></h4> <p><strong>Thread-local (локальні для потоку) змінні</strong> — це механізм, який дозволяє зберігати дані, специфічні для кожного потоку. Це означає, що кожен потік має свій власний набір значень цих змінних, незалежний від інших потоків. У Python це реалізовано через клас <code>threading.local</code>. Python створює окремий простір для кожного потоку, де зберігаються всі атрибути, додані до об'єкта <code>threading.local</code>. Цей простір зв'язується з ідентифікатором потоку (<code>thread ID</code>) і зникає разом із завершенням потоку.</p> <p><code>threading.local</code> працює наступним чином - Ізоляція даних: Кожен потік має окремий простір для зберігання значень <code>thread-local</code> змінних. Значення, встановлене в одному потоці, недоступне іншому. - <code>Thread-local</code> змінні доступні так само, як звичайні атрибути об'єкта.</p> <p><code>Thread-local</code> використовуються щоб - Зберігати тимчасові дані, специфічні для потоку (наприклад, ідентифікатор користувача, контекст запиту). - Уникнути передавання додаткових параметрів через функції. - Локалізувати стан в багатопоточних додатках, зберігаючи читабельність коду.</p> <p>В django ORM та алхімії <code>thread-local</code> використовується для того, щоб для кожного треда зберігати свій конекшн в БД.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=kn>import</span><span class=w> </span><span class=nn>threading</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=n>local_data</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>local</span><span class=p>()</span>  <span class=c1># Create a thread-local storage object</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=k>def</span><span class=w> </span><span class=nf>process_data</span><span class=p>():</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Thread </span><span class=si>{</span><span class=n>threading</span><span class=o>.</span><span class=n>current_thread</span><span class=p>()</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> has value: </span><span class=si>{</span><span class=n>local_data</span><span class=o>.</span><span class=n>value</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=k>def</span><span class=w> </span><span class=nf>worker</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a>    <span class=n>local_data</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>value</span>  <span class=c1># Assign a thread-specific value</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a>    <span class=n>process_data</span><span class=p>()</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=n>threads</span> <span class=o>=</span> <span class=p>[</span><span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>worker</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>i</span><span class=p>,),</span> <span class=n>name</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Thread-</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>)]</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a>    <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>threads</span><span class=p>:</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a>    <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></code></pre></div> <div class="language-text highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>Thread Thread-0 has value: 0
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>Thread Thread-1 has value: 1
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>Thread Thread-2 has value: 2
</span></code></pre></div> <p><em>Links</em></p> <ul> <li><a href=https://docs.python.org/3/library/threading.html#thread-local-data>https://docs.python.org/3/library/threading.html#thread-local-data</a></li> </ul> <h4 id=_5>Які завдання добре паралеляться, а які погано<a class=headerlink href=#_5 title="Permanent link">⚑</a></h4> <p><em>Summary</em></p> <blockquote> <p>Добре паралеляться IO-bound, погано - CPU-bound.</p> </blockquote> <p>Добре паралеляться завдання, які виконують тривалу операцію вводу-виводу. Коли потік чекає на завершення сокета або диску, інтерпретатор переключає цей потік і запускає наступний. Це означає, що не буде простою через очікування. З іншого боку, якщо в одному потоці здійснювати мережеві дзвінки (у циклі), то кожного разу доведеться чекати на відповідь.</p> <p>Проте, якщо потім потрібно обробити отримані дані в потоці, то буде виконуватися лише один потік. Це не тільки не додасть швидкодії, але й сповільнить програму через переключення на інші потоки.</p> <p>Завдання, пов'язані з мережею, добре підходять для потоків. Наприклад, завантаження ста URL-адрес. Отримані дані потрібно обробляти поза потоками.</p> <h4 id=_6>Що таке блокуючі операції<a class=headerlink href=#_6 title="Permanent link">⚑</a></h4> <p>У контексті асинхронного програмування, блокуючі операції - це операції, які затримують виконання коду та очікують на результат. Під час блокування інші задачі не можуть виконуватись, оскільки весь потік виконання зупиняється.</p> <p>Основні приклади блокуючих операцій включають: - Операції затримки (наприклад, time.sleep()): Ці операції призводять до призупинки виконання коду на задану тривалість. Протягом цього часу інші задачі не можуть продовжувати своє виконання. - Очікування блокування ресурсів: Це включає ситуації, коли код намагається отримати доступ до ресурсів, які зайняті іншими задачами. Коли ресурс заблокований, виконання потоку зупиняється, поки ресурс не стане доступним.</p> <p>Асинхронний код дозволяє уникнути блокування під час таких операцій, дозволяючи іншим задачам продовжувати виконання.</p> <h4 id=100>Потрібно обчислити 100 рівнянь. Робити це у потоках або ні<a class=headerlink href=#100 title="Permanent link">⚑</a></h4> <p>Ні, оскільки у цій задачі немає операцій вводу-виводу. Інтерпретатор лише витратить додатковий час на переключення потоків. Складні математичні завдання краще винести в окремі процеси або використовувати фреймворк для розподілених завдань, такий як Celery, або підключати C-бібліотеки.</p> <h4 id=_7>Що таке грінлети. Загальне поняття. Приклади реалізацій<a class=headerlink href=#_7 title="Permanent link">⚑</a></h4> <p>Грінлети - Greenlet - Green thread - Зелені потоки - Легкі потоки всередині віртуальної машини. Вони можуть називатися корутинами, субпроцесами, акторами та іншими, залежно від платформи. </p> <p>Операційна система їх не бачить. З точки зору операційної системи, запущений лише один процес віртуальної машини, а те, що відбувається всередині, не відомо. Управління такими потоками відбувається самою віртуальною машиною: вона створює їх, виконує, координує доступ до ресурсів.</p> <p>Приклади: корутини в мовах Go і Lua, легкі процеси в Erlang, модуль greenlet для Python. Модуль gevent використовує грінлети.</p> <h4 id=_8>Сигнали та планувальники потоків<a class=headerlink href=#_8 title="Permanent link">⚑</a></h4> <p>Сигнали в Python є способом взаємодії між процесами, який дозволяє операційній системі або іншим програмам надсилати асинхронні повідомлення програмі, що виконується. Наприклад, коли користувач натискає <code>Ctrl+C</code>, генерується сигнал <code>SIGINT</code>, який зазвичай завершує програму. Варто зазначити, що в Python можна змінити стандартну поведінку сигналу (окрім тих, котрі обробляються безпосередньо операційною системою, до прикладу <code>SIGKILL</code> і <code>SIGSTOP</code>).</p> <p>Сигнали мають обмеження: вони працюють лише в основному потоці Python. Якщо програма використовує багатопоточність, все одно сигнали можуть надходити й оброблятися виключно в головному потоці. Тому може виникнути проблема із завершенням багатопотокових програм, а саме спробами зупинити виконання коду за допомогою <code>Ctrl+C</code>. Справа в тому, що програма, запущена в кількох потоках, не може бути зупинена за допомогою переривання клавіатурою (keyboard interrupt).</p> <p>У Python сигнали, такі як <code>SIGINT</code>, обробляються тільки в головному потоці. Якщо головний потік заблокований, наприклад, під час очікування завершення іншого потоку (thread-join) або утримування блокування (lock), обробник сигналу може не отримати можливості виконатися, у результаті програма продовжить працювати, навіть якщо сигнал було надіслано. <code>kill —9</code>, на відміну від <code>Ctrl+C</code>, надішле сигнал <code>SIGKILL</code>, який не може бути перехоплений, проігнорований або змінений програмою, а отже обов’язково виконається та зупинить програму.</p> <p>Тож коли надходить сигнал, інтерпретатор Python виконує перевірку (check) після кожних 5 ms доти, доки не активується головний потік. Оскільки обробники сигналів можуть виконуватись виключно в головному потоці, інтерпретатор часто змушений вимикати та вмикати GIL, допоки головний потік не отримає управління.</p> <p>Така хаотичність при перемиканні між потоками після отримання сигналу пов’язана з пов’язана з плануванням потоків у Python. У Python немає засобів для визначення того, який потік має виконуватися наступним. Відсутні такі механізми, як пріоритети, витісняюча багатозадачність чи кругова черга (round-robin) тощо. Управління виконанням потоків повністю покладається на операційну систему. Це одна з причин непередбачуваної поведінки сигналів: інтерпретатор не контролює порядок запуску потоків, а лише перемикає їх якомога частіше, сподіваючись, що головний потік отримає можливість виконатися.</p> <p>У результаті програма не лише втрачає можливість бути зупиненою, але й працює повільніше через постійні перемикання.</p> <h4 id=fork>Що таке системний виклик <code>fork</code>?<a class=headerlink href=#fork title="Permanent link">⚑</a></h4> <p>Для створення процесів у Linux можна використовувати два системні виклики</p> <ul> <li><a href=https://linux.die.net/man/2/clone><code>clone()</code></a>. Це основна функція для створення дочірніх процесів. За допомогою прапорців розробник вказує, які структури батьківського процесу повинні бути спільними з дочірнім. Базово використовується для створення потоків (мають спільний простір адрес, файлові дескриптори, обробники сигналів).</li> <li><a href=https://linux.die.net/man/2/fork><code>fork()</code></a>. Ця функція використовується для створення процесів (які мають власний простір адрес) у Unix-системах, таких як Linux та macOS. Під капотом викликає <code>clone()</code> з певним набором прапорців. Він створює точну копію батьківського процесу, включаючи його пам'ять, змінні та стан. Отриманий новий процес називається дочірнім, а процес, який його створив, - батьківським. При цьому копія працює незалежно і може змінювати свій стан без впливу на батьківський процес. Сучасні Unix-системи реалізують механізм Copy-on-Write (COW), що означає, що пам’ять фактично не копіюється при створенні процесу, а лише позначається як спільна. Якщо дочірній процес змінює дані в пам’яті, тоді операційна система фізично копіює змінений блок, щоб уникнути конфлікту між процесами.</li> <li>На Windows створення процесу працює інакше, оскільки <code>fork()</code> не підтримується. Натомість використовується метод <code>spawn()</code>, при якому новий процес стартується «з нуля» і не успадковує пам’ять батьківського процесу. Це означає, що при створенні процесу виконується новий екземпляр інтерпретатора Python, який завантажує весь необхідний код заново. Через це створення процесів у Windows є повільнішим порівняно з Unix-системами, адже немає оптимізації через Copy-on-Write.</li> </ul> <p>Після виклику <code>fork()</code>, обидва процеси (батьківський та дочірній) продовжують виконувати однаковий код, але вони мають свої власні примірники змінних та інших ресурсів. Після створення процесу операційна система надає йому унікальний ідентифікатор процесу (<code>PID</code>) та додає його в таблицю процесів. Далі планувальник операційної системи визначає, коли і на якому ядрі CPU цей процес буде виконуватись.</p> <h4 id=->Для яких завдань варто використовувати потоки, для яких - процеси, а для яких - асинхронність?<a class=headerlink href=#- title="Permanent link">⚑</a></h4> <p><em>Summary</em></p> <ul> <li>CPU-залежна задача =&gt; Multi Processing</li> <li>I/O-залежна, швидкий I/O =&gt; Multi Threading</li> <li>I/O-залежна, повільний I/O =&gt; Asyncio (робота з вебсокетами)</li> </ul> <p>Наприклад треба написати HTTP або WebSocket сервер, який обробляє кожне з'єднання в окремому потоці.</p> <p>Можна створити 100, а можливо, навіть 500 потоків, щоб обробити необхідну кількість одночасних з'єднань. Для коротких запитів це може працювати і дозволити витримувати навантаження 5000 RPS на найбільш доступному DO інстансі за п'ять доларів - це досить непогано. Якщо менше, то можливо вам не потрібні жодні AsyncIO/Tornado/Twisted.</p> <p>Але що, якщо їх кількість наближається до нескінченності, наприклад, це великий чат з багатьма каналами, кількість одночасних учасників в якому необмежена. У такій ситуації краще не створювати стільки потоків, щоб вистачило кожному користувачеві. </p> <p>Як уже зазначалося, поки GIL захоплений одним потоком, інші потоки не будуть працювати. Планувальник операційної системи про цей GIL нічого не знає і все одно буде віддавати процесор заблокованим потокам. Цей потік, звичайно, побачить, що GIL захоплений і одразу засне, але на перемикання контексту процесора буде витрачатися дорогоцінний час.</p> <p>Перемикання контексту - взагалі витратна для процесора операція, яка потребує скидання регістрів, кешу та таблиці відображення сторінок пам'яті. Чим більше потоків запущено, тим більше процесор робить марні перемикання на потоки, що заблоковані GIL, перед тим, як дістатися до того самого, який утримує цей GIL. Не дуже ефективно.</p> <p>Є також співпрограми - те, що пропонує AsyncIO і Tornado. Їх також називають корутинами або просто потоками на рівні користувача, які використовувалася ще в часи, коли були операційні системи без підтримки багатозадачності.</p> <p>На відміну від потоків, співпрограми виконують лише корисну роботу, а перемикання між ними відбувається лише у той момент, коли співпрограма очікує завершення якоїсь зовнішньої операції.</p> <p>Як і у випадку з потоками, асинхронні фреймворки використовуються для I/O-bound задач - таких як мережеві виклики, взаємодія з базами даних, робота з файлами. Для CPU-bound задач, які вимагають багато обчислень, такий підхід може бути неефективним, оскільки співпрограми теж працюють в одному потоці через GIL.</p> <p>Ще одна найважливіша особливість корутину полягає в тому, що вони легкі. Вони "легші" за потоки. Тобто швидше запускаються і використовують менше пам'яті. По суті, корутини – це особливий різновид функцій, а от потоки представлені Python-об'єктами та пов'язані з потоками в операційній системі, з якими ці об'єкти мають взаємодіяти. Переключення між потоками відбувається тоді, коли заманеться операційній системі. У випадку з asyncio - переключення може відбутись на await, що дає більше контролю над програмою.</p> <p>В Python-програмі можуть міститись тисячі потоків. А якщо говорити про корутини, то їх уже можуть бути десятки або сотні тисячі, і всі вони будуть розміщені в одному потоці.</p> <p>Якщо задача потребує інтенсивних обчислень (CPU-bound), то потрібно використовувати процеси або оптимізації. Бібліотеки NumPy, Pandas вміють відпускати GIL. Також можна переписати критичні частини коду з допомогою Cyton, Numba, Clang. Оптимальна кількість процесів зазвичай дорівнює або трохи менша кількості ядер процесора. Рекомендується залишати хоча б одне ядро вільним, наприклад, запускати <code>cpu_count() - 1</code> процесів, або експериментально визначати оптимальну кількість.</p> <p><em>Links</em></p> <ul> <li><a href=https://devzone.org.ua/post/asinxronnii-python-vidi-konkurentnosti>Асинхронний Python: види конкурентності - DevZone.ua</a></li> <li><a href=https://dou.ua/forums/topic/48847/ >Швидко та недорого покращуємо перфоманс невеликого Python-проєкту</a></li> <li><a href=https://dou.ua/forums/topic/53004/ >Розділяй і володарюй. Як працюють процеси в Python - dou.ua</a></li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="July 15, 2025 11:36:11 UTC"><span class=timeago datetime=2025-07-15T11:36:11+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="July 15, 2025 11:36:11 UTC">2025-07-15</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../async/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Async"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Async </div> </div> </a> <a href=../interpreter/ class="md-footer__link md-footer__link--next" aria-label="Next: Interpreter"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Interpreter </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/tavor118 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.footer", "navigation.instant", "navigation.top", "content.code.annotate", "content.code.copy", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.f55a23d4.min.js></script> <script src=../../js/timeago.min.js></script> <script src=../../js/timeago_mkdocs_material.js></script> </body> </html>