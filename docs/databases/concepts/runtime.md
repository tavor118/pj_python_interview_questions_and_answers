## Виконання

### Сесія, курсор

**Сесія**  - це окремий сеанс зв’язку між клієнтом і сервером бази даних. Сесія починається при встановленні з'єднання з БД і закінчується після його завершення. У рамках однієї сесії клієнт може виконувати кілька запитів до бази. Для кожної сесії сервер виділяє ресурси, що може стати обмеженням при великій кількості підключень.

**Курсор**  - це об'єкт, який використовується для виконання SQL-запитів і отримання результатів. Курсор дозволяє обробляти результати запиту поетапно, зменшуючи обсяг пам’яті, необхідної для зберігання даних у пам'яті клієнта.

Приклад роботи з курсором у Python (модуль `psycopg2`)

```python
import psycopg2

connection = psycopg2.connect("dbname=test user=postgres password=secret")  # Connect to the database
cursor = connection.cursor()  # Create a cursor
cursor.execute("SELECT * FROM users")  # Execute a query

for row in cursor.fetchall():  # Fetch results
	print(row)

cursor.close()  # Close cursor and connection
connection.close()
```

### Що таке курсор і навіщо він потрібен

Запит до реляційної бази даних зазвичай повертає кілька рядків (записів) даних, але програма за один раз обробляє лише один запис. Навіть якщо вона має справу одночасно з декількома рядками (наприклад, виводить дані у формі електронних таблиць), їх кількість все ще обмежена. Крім того, при модифікації, видаленні або додаванні даних робочою одиницею є рядок. У цій ситуації на передній план виступає концепція курсора, і в такому контексті курсор - вказівник на рядок.

**Курсор в SQL** - це область в пам'яті бази даних, яка призначена для зберігання останнього оператора SQL. Якщо поточний оператор - запит до бази даних, в пам'яті зберігається рядок даних запиту, який називається поточним значенням або поточним рядком курсора. Зазначена область в пам'яті має ім'я і доступна для прикладних програм.

Зазвичай курсори використовуються для вибору з бази даних певної підмножини збереженої в ній інформації. В кожний момент часу прикладною програмою може бути перевірений один рядок курсора. Курсори часто використовуються в операторах SQL, вбудованих у написані на мовах процедурного типу прикладні програми. Деякі з них неявно створюються сервером бази даних, тоді як інші визначаються програмістами.

У деяких випадках застосування курсора необхідно. Однак, якщо це можливо, цього слід уникати і працювати зі стандартними командами обробки даних: SELECT, UPDATE, INSERT, DELETE. Крім того, що курсори не дозволяють здійснювати операції зміни над всім обсягом даних, швидкість виконання операцій обробки даних за допомогою курсора помітно нижча, ніж у стандартних засобів SQL.

### Пул з'єднань, PgBouncer

**Пул з'єднань**  - це механізм повторного використання вже існуючих з'єднань із базою даних. Він дозволяє уникнути витрат на створення нових з'єднань при кожному запиті, що суттєво підвищує продуктивність додатка.

В Python пул з'єднань можна реалізувати за допомогою бібліотеки `psycopg2` або ORM, як-от SQLAlchemy:

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

engine = create_engine("postgresql://user:password@localhost/db", pool_size=10, max_overflow=5)  # Create a connection pool

Session = sessionmaker(bind=engine)  # Create a session
session = Session()

result = session.execute("SELECT * FROM users")  # Execute a query
for row in result:
	print(row)

session.close()  # Close the session
```

**PgBouncer**  - це легкий проксі-сервер для PostgreSQL, який виконує функції пулінгу з'єднань. PgBouncer дозволяє зменшити навантаження на сервер бази даних, зменшуючи кількість одночасних з'єднань.

Він підтримує кілька режимів роботи

- **Session pooling**: кожне з'єднання клієнта відповідає одній сесії сервера.
- **Transaction pooling**: з'єднання використовується лише для однієї транзакції.
- **Statement pooling**: з'єднання використовується для виконання одного SQL-запиту.

### Що таке тригери?

**Тригери** - це збережені процедури, які автоматично (які користувач не викликає явно) виконуються (або "спрацьовують") при виникненні певних подій або умов в базі даних. Вони можуть бути використані для відстеження змін у таблицях, валідації даних перед вставкою або оновленням, автоматичного виконання певних операцій після виконання певних дій користувача та інші сценарії.

Тригери можуть бути визначені для подій, таких як вставка (`INSERT`), оновлення (`UPDATE`), видалення (`DELETE`) записів у таблицях, і вони можуть допомагати забезпечити цілісність даних та реалізувати бізнес-логіку в базі даних.

```SQL
-- Example trigger in SQL to track changes in the "Clients" table
CREATE TRIGGER track_changes
AFTER INSERT OR UPDATE OR DELETE ON Clients
FOR EACH ROW
BEGIN
    -- Logging changes in the "Clients" table
    INSERT INTO Change_Log (Action, Timestamp, User, Changes)
    VALUES ('INSERT/UPDATE/DELETE', NOW(), CURRENT_USER, NEW);
END;

```