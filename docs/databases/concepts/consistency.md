## Узгодженість

### Яка різниця між BASE і ACID?

**BASE:** Це підхід до дизайну систем управління базами даних, який ставить акцент на доступність та швидкодію. BASE розшифровується як "Basically Available, Soft state, Eventually consistent" (базова доступність, нестійкий стан,  консистентна в кінцевому рахунку).

- Під базовою доступністю розуміється такий підхід до проектування додатка, за якого збій в деяких вузлах призводить до відмови в обслуговуванні лише для незначної частини сеансів, зі збереженням доступності в більшості випадків.
- Нестійкий стан передбачає можливість пожертвувати довгостроковим зберіганням стану сеансів (такого як проміжні результати виборок, інформація про навігацію, контекст), зосереджуючись при цьому на фіксації оновлень лише критичних операцій.
- Узгодженість у кінцевому підсумку, яка трактується як можливість суперечливості даних у деяких випадках, але за умови забезпечення узгодженості протягом практично прийнятного часу.

Таким чином, згідно з підходом BASE, система може тимчасово допускати неузгодженість даних для забезпечення високої доступності та швидкості в операціях. Це особливо важливо в розподілених системах, де збереження строгої консистентності може призвести до затримок.


**ACID:** Це набір властивостей, які визначають надійність транзакцій у системах управління базами даних. ACID розшифровується як "Atomicity, Consistency, Isolation, Durability" (Атомарність, Цілісність, Ізоляція, Довговічність). Ці властивості гарантують, що транзакції виконуються надійно: вони атомарні (або повністю виконуються або взагалі не виконуються), зберігають цілісність даних, ізолюються одна від одної та є стійкими до відмов.

Отже, різниця полягає в підході: ACID надає пріоритет стабільності, цілісності та гарантії цілісності даних, тоді як BASE більше акцентується на доступності, швидкості та готовності системи працювати навіть за умови відмов.

### Що таке транзакція? Що таке ACID?

**Транзакція** - це послідовність дій, які виконуються в базі даних або іншій системі з метою забезпечення консистентності даних та виконання операцій атомарно (тобто вони повинні бути виконані цілісно або не виконуватися взагалі - все або нічого). Іншими словами, транзакція - це група дій, які мають бути виконані як єдине ціле. Транзакція є робочою одиницею роботи з базою даних (надалі - БД).

Транзакція - це внесення змін у БД. Наприклад, якщо ми створюємо, змінюємо або видаляємо запис, то ми виконуємо транзакцію. Дуже важливо контролювати транзакції для гарантування цілісності. Крім того, транзакції дозволяють відновлювати базу даних до попереднього стану в разі виникнення помилки або аварії.

Основні концепції (властивості) транзакції описуються абревіатурою ACID

- Atomicity - Атомарність
- Consistency - Узгодженість
- Isolation - Ізоляція
- Durability - Довговічність

**Атомарність**
Атомарність гарантує, що транзакція або виконується повністю або зовсім не виконується. Якщо одна з операцій у послідовності не буде виконана, то вся транзакція буде відмінена. Тут вводиться поняття "відкату" (rollback). Тобто всередині послідовності відбуватимуться певні зміни, але в результаті всі вони будуть скасовані ("відкочені"), і в результаті користувач не побачить жодних змін. У випадку вкладених транзакцій, rollback відбувається до найближчого SAVEPOINT.

Наприклад, якщо гроші списалися з одного рахунку, але не надійшли на інший через помилку, вся операція скасовується і гроші залишаються на першому рахунку.

**Узгодженість**
Узгодженість означає, що будь-яка завершена транзакція (транзакція, яка досягла завершення транзакції - end of transaction) фіксує лише допустимі результати. Система має перебувати в узгодженому, несуперечливому стані до початку дії транзакції і по її завершенню. При цьому вона може перебувати в неузгодженому стані протягом виконання транзакції, проте ця неузгодженість не буде видимою за межами транзакції завдяки іншим властивостям — атомарності та ізольованості.

Наприклад, при переведенні коштів з рахунку на рахунок, кошти можна спочатку зняти з першого рахунку, після чого нараховувати на другий. Відповідно, після зняття коштів, але до їх нарахування система перебуває в неузгодженому стані: коштів немає на жодному з рахунків. Але після завершення транзакції повна сума перебуватиме на другому (або першому у випадку скасування транзакції) рахунку.

**Ізоляція**
Кожна транзакція повинна бути ізольована від інших, тобто її результат не повинен залежати від виконання інших паралельних транзакцій. На практиці, ізоляції важко досягнути, тому тут вводиться поняття "рівні ізоляції" (транзакція ізолюється не повністю).

Наприклад дві людини одночасно намагаються змінити баланс на одному рахунку. Ізольованість гарантує, що одна транзакція не вплине на іншу.

**Довговічність**
Довговічність означає, що після успішного завершення транзакції її результати зберігаються у базі даних, навіть якщо відбувається збій системи. Це означає, що дані не втрачаються і залишаються доступними після будь-яких помилок, таких як збій живлення.

Наприклад після того, як ви завершили переказ грошей, нова інформація про баланси зберігається і залишається доступною, навіть якщо сервер бази даних раптово вимкнеться. Коли сервер перезапуститься, дані будуть відновлені, оскільки транзакцію було завершено.

*Links*

- [Використання транзакцій в реляційних базах даних: забезпечення надійності та цілісності](https://dou.ua/forums/topic/46677/)



### Які команди управління транзакціями ви знаєте

Для управління транзакціями використовуються наступні команди

- `COMMIT`: Зберігає зміни
- `ROLLBACK`: Відкочує (скасовує) зміни
- `SAVEPOINT`: Створює точку, до якої група транзакцій може відкотитися
- `SET TRANSACTION`: Розміщує ім'я транзакції.

Команди управління транзакціями використовуються тільки для DML команд: `INSERT`, `UPDATE`, `DELETE`. Вони не можуть бути використані під час створення, зміни або видалення таблиці.

*Links*

- [Руководство по SQL. Транзакции](https://proselyte.net/tutorials/sql/sql-transactions/)

### Що таке рівні ізоляції транзакцій. Які вони бувають

**Ізоляція** у сенсі ACID означає, що конкурентно виконувані транзакції ізольовані одна від одної - вони не можуть заважати одна одній. Класичні підручники з баз даних розуміють під ізоляцією серіалізованість (serializability). Тобто кожна транзакція виконується так, наче вона єдина в усій базі. БД гарантує, що результат фіксації транзакцій такий самий, як якщо б вони виконувались послідовно (по одній за раз), хоча насправді вони можуть виконуватись конкурентно.

При паралельному виконанні транзакцій можливі такі проблеми

- втрачене оновлення (lost update) — при одночасній зміні одного блоку даних різними транзакціями, одна із змін втрачається;
- "брудне" читання (dirty read) — читання даних, які додані чи змінені транзакцією, яка потім не підтвердиться (відкотиться);
- неповторюване читання ( non-repeatable read) — при повторному читанні в рамках однієї транзакції, раніше прочитані дані з'являються зміненими;
- фантомне читання (phantom reads) — одна транзакція в ході свого виконання декілька разів вибирає множину рядків за одними і тими ж критеріями. Інша транзакція в інтервалах між цими вибірками додає чи видаляє рядки чи змінює стовпці деяких рядків, що використовується в критеріях вибірки першої транзакції, і успішно закінчується. В результаті отримаємо, що одні і ті ж вибірки в першій транзакції дають різні множини рядків.

**Рівень ізольованості транзакцій** — значення, що задає рівень, при якому в транзакції дозволяються неузгоджені дані, тобто ступінь ізольованості однієї транзакції від іншої. Більш високий рівень ізольованості підвищує точність даних, але при цьому може знижуватись кількість транзакцій, що виконуються паралельно. З іншого боку, більш низький рівень ізольованості дозволяє виконувати більше паралельних транзакцій, але знижує точність даних.

У стандарті SQL описується чотири рівні ізоляції транзакцій

- Read uncommited (Читання незафіксованих даних)
- Read committed (Читання зафіксованих даних)
- Repeatable read (Повторюване читання)
- Serializable (Серіалізований)

**Read Uncommitted**
Найнижчий рівень ізоляції. Транзакція може читати дані, які ще не були зафіксовані іншою транзакцією. Це може призводити до "брудного читання" (dirty reads), коли транзакція працює з даними, які можуть бути відкочені.

**Read Committed**
Транзакція бачить лише ті зміни, які вже зафіксовані іншими транзакціями. Це запобігає "брудному читанню", але не вирішує проблему "неповторюваного читання" (non-repeatable reads), коли один і той самий запит повертає різні результати в межах однієї транзакції.

Реалізація завершеного читання може ґрунтуватися на одному з двох підходів: блокуванні або версійності.

- **Блокування даних, що читаються та змінюються.**
    - Полягає в тому, що пишуча транзакція блокує змінні дані для читаючих транзакцій, що працюють на рівні read committed або вищому, до свого завершення, перешкоджаючи таким чином «брудному» читанню, а дані, що зчитуються, які блокуються транзакцією, звільняються одразу після завершення операції `SELECT` (отже ситуація «неповторного читання» може виникати на даному рівні ізоляції).
- **Збереження декількох версій рядків, що змінюються паралельно.**
    - При кожній зміні рядка СУБД створює нову версію цього рядка, з якої продовжує працювати транзакція, що змінила дані, в той час як будь-якій іншій «читає» транзакції повертається остання зафіксована версія. Перевага такого підходу в тому, що він забезпечує більшу швидкість, оскільки запобігає блокуванню. Однак він вимагає, порівняно з першим, значно більшої витрати оперативної пам'яті, яка витрачається на зберігання версій рядків.

**Repeatable Read**
Забезпечує, що дані, прочитані транзакцією, залишаються незмінними до її завершення. Вирішує проблему "неповторюваного читання", але не запобігає "фантомному читанню" (phantom reads), коли нові рядки додаються іншими транзакціями і впливають на результати.

**Serializable**
Найвищий рівень ізоляції. Гарантує, що транзакції виконуються так, ніби вони були послідовними, тобто одна за одною. Усуває всі згадані проблеми, включаючи "фантомне читання", але може значно знизити продуктивність через блокування ресурсів.

За замовчуванням у PostgreSQL рівень ізоляції Read Committed. Такий рівень ізоляції завжди дозволяє бачити зміни внесені успішно завершеними транзакціями в паралельно відкритих транзакціях, що залишилися. У транзакції, що працює на цьому рівні, запит SELECT (без FOR UPDATE/SHARE) бачить лише дані, які були зафіксовані до початку запиту; він ніколи не побачить незафіксованих даних чи змін, внесених у процесі виконання запиту паралельними транзакціями. По суті, запит SELECT бачить знімок бази даних у момент початку виконання запиту. Однак SELECT бачить результати змін, внесених раніше в цій транзакції, навіть якщо вони ще не зафіксовані. Також треба зауважити, що два послідовні оператори SELECT можуть бачити різні дані навіть у рамках однієї транзакції, якщо якісь інші транзакції зафіксують зміни після виконання першого SELECT.

### Вкладені транзакції

Вкладеними називаються транзакції, виконання яких ініціюється з тіла вже активної транзакції.

Для створення вкладеної транзакції користувачеві не потрібні жодні додаткові команди. Він просто розпочинає нову транзакцію, не закриваючи попередню. Завершення транзакції верхнього рівня відкладається до завершення вкладених транзакцій. Якщо транзакція самого нижчого (вкладеного) рівня завершена невдало і скасована, то всі транзакції верхнього рівня, включаючи транзакцію першого рівня, будуть скасовані. Крім того, якщо декілька транзакцій нижнього рівня завершилися успішно (але не були зафіксовані), однак на середньому рівні (не найвища транзакція) невдало завершилася інша транзакція, то згідно
з вимогами ACID відбудеться відкат всіх транзакцій всіх рівнів, включаючи успішно завершені. Лише коли всі транзакції на всіх рівнях завершено успішно, відбувається фіксація всіх зроблених змін у результаті успішного завершення транзакції верхнього рівня.

Кожна команда COMMIT TRANSACTION працює лише з останньою розпочатою транзакцією. При завершенні вкладеної транзакції команда COMMIT застосовується до найбільш "глибокої" вкладеної транзакції. Навіть якщо в команді COMMIT TRANSACTION вказано ім'я транзакції вищого рівня, буде завершена транзакція, розпочата останньою.

